<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Food Saver | Available Food</title>
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/user.css">
</head>

<body>

<script>
/* üîê USER ACCESS GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");
const email = localStorage.getItem("email");

if (!token || role?.toUpperCase() !== "USER") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">
  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="user-dashboard.html">Dashboard</a>
      <a class="active">Available Food</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <main class="content">
    <header class="topbar">
      <h1>Available Food</h1>
      <div class="top-actions">
         <input type="search" id="searchInput" placeholder="Search food / location / hall" />
        <div class="avatar">NGO</div>
      </div>
    </header>

    <section class="surplus-grid" id="grid"></section>
  </main>
</div>

<script>
/* ===== BASE URL (RENDER BACKEND) ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";

/* ===== AUTH HEADERS ===== */
function authHeaders() {
  return { Authorization: "Bearer " + token };
}

let allFood = [];

/* ================= RENDER ================= */
function render(data) {
  grid.innerHTML = "";

  if (!data.length) {
    grid.innerHTML = "<p>No food available.</p>";
    return;
  }

  data.forEach(item => {
    grid.innerHTML += `
      <div class="surplus-card"
           data-created="${item.createdAt}"
           data-expiry="${item.expiryHours}">
        <h3>${item.foodName}</h3>
        <p>üìç ${item.location}</p>
        <p>üë• Serves: ${item.quantity}</p>
        <p>üè¢ Posted by: <b>${item.postedBy}</b></p>
        <p>‚è≥ Expires in <span class="expiry-time">--</span></p>

        ${
          item.status === "ACCEPTED"
            ? `<button disabled class="primary-btn small" style="opacity:.6">
                 Accepted ‚úî
               </button>`
            : `<button class="primary-btn small"
                 onclick="acceptFood(${item.id})">
                 Accept
               </button>`
        }
      </div>
    `;
  });

  startExpiryTimers();
}

/* ================= LOAD ================= */
function loadFood() {
  fetch(`${BASE_URL}/api/user/surplus`, { headers: authHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(data => {

      allFood = data.filter(item => {
        const created = new Date(item.createdAt).getTime();
        const expiry  = created + item.expiryHours * 3600000;

        // ‚úÖ REMOVE IF ADMIN PICKED
        if (item.status === "PICKED") return false;

        // ‚úÖ REMOVE IF EXPIRED
        if (expiry <= Date.now()) return false;

        return true;
      });

      render(allFood);
      enableSearch(allFood, render);
    });
}
/* ================= SEARCH ================= */
function enableSearch(source, renderFn) {
  searchInput.addEventListener("input", e => {
    const q = e.target.value.toLowerCase().trim();

    if (!q) {
      renderFn(source);
      return;
    }

    renderFn(
      source.filter(i =>
        i.foodName.toLowerCase().includes(q) ||
        i.location.toLowerCase().includes(q) ||
        i.postedBy.toLowerCase().includes(q)
      )
    );
  });
}

/* ================= ACCEPT ================= */
function acceptFood(id) {
  fetch(`${BASE_URL}/api/surplus/${id}/accept?email=${email}`, {
    method: "PUT",
    headers: authHeaders()
  }).then(() => {
    const item = allFood.find(f => f.id === id);
    if (item) item.status = "ACCEPTED";
    render(allFood);
  });
}

/* ================= LIVE EXPIRY TIMER ================= */
function startExpiryTimers() {
  document.querySelectorAll(".surplus-card").forEach(card => {
    const el = card.querySelector(".expiry-time");

    const interval = setInterval(() => {
      const created = new Date(card.dataset.created).getTime();
      const expiry  = created + card.dataset.expiry * 3600000;
      const diff    = expiry - Date.now();

      if (diff <= 0) {
        clearInterval(interval);
        card.remove(); // ‚úÖ REMOVE AFTER EXPIRY
        return;
      }

      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      el.textContent = `${h}h ${m}m ${s}s`;
    }, 1000);
  });
}

/* INIT */
loadFood();

/* LOGOUT */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

<script>
function toggleSidebar() {
  document.querySelector(".sidebar").classList.toggle("open");
}
</script>  

<script src="../js/app.js"></script>
</body>
</html>








