<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Dashboard</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>
<body>

<script>
/* üîê ADMIN GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a class="active">Dashboard</a>
      <a data-page="surplus.html">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
    <div class="sidebar-footer">Zero Waste üå±</div>
  </aside>

  <main class="content">

    <header class="topbar">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <button id="themeToggle" class="outline-btn">üåô</button>
      <h1 id="welcomeText">Dashboard</h1>
      <div class="top-actions">
        <button class="primary-btn" onclick="location.href='surplus.html'">
          + Add Surplus
        </button>
        <div class="avatar" id="adminAvatar">ADM</div>
      </div>
    </header>

    <section class="cards">
      <div class="card">
        <p>Total Surplus Items (Today)</p>
        <h2 id="totalSurplus">0</h2>
        <span class="positive">Live data</span>
      </div>

      <div class="card">
        <p>Food Accepted by NGOs</p>
        <h2 id="acceptedCount">0</h2>
        <span class="positive">Ready for pickup</span>
      </div>

      <div class="card">
        <p>Food Picked</p>
        <h2 id="pickedCount">0</h2>
        <span class="positive">Successfully delivered</span>
      </div>
    </section>

  </main>
</div>

<script>
/* ===== BASE URL (RENDER BACKEND) ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";

/* ===== AUTH HEADERS ===== */
function authHeaders() {
  return {
    Authorization: "Bearer " + localStorage.getItem("token")
  };
}
</script>

<script>
/* ===== ADMIN DASHBOARD ===== */
function loadAdminDashboard() {
  fetch(`${BASE_URL}/api/dashboard/admin`, {
    headers: authHeaders()
  })
  .then(res => {
    if (res.status === 401) {
      localStorage.clear();
      window.location.href = "../index.html";
      return null;
    }
    return res.json();
  })
  .then(data => {
    if (!data) return;

    totalSurplus.textContent  = data.addedToday;
    acceptedCount.textContent = data.awaitingPickup;
    pickedCount.textContent   = data.picked;
  })
  .catch(err => console.error("Dashboard error:", err));
}

loadAdminDashboard();
setInterval(loadAdminDashboard, 5000);
</script>

<script>
/* ===== ADMIN NAME ===== */
const SETTINGS_API = `${BASE_URL}/api/settings`;
const email = localStorage.getItem("email");

if (email) {
  fetch(`${SETTINGS_API}?email=${email}`, { headers: authHeaders() })
    .then(res => res.ok ? res.json() : null)
    .then(data => {
      if (!data || !data.organizationName) return;

      adminAvatar.textContent =
        data.organizationName.substring(0, 3).toUpperCase();
      welcomeText.textContent =
        `Welcome, ${data.organizationName}`;
    });
}
</script>

<script>
/* LOGOUT */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

<script>
function toggleSidebar() {
  document.querySelector(".sidebar").classList.toggle("open");
}
</script>

<script src="../js/app.js"></script>
</body>
</html>
