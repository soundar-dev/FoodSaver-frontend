<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Settings</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>
<body>

<script>
/* üîê ADMIN AUTH GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");
const email = localStorage.getItem("email");

if (!token || role !== "ADMIN" || !email) {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a data-page="surplus.html">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a class="active">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
    <div class="sidebar-footer">Zero Waste üå±</div>
  </aside>

  <main class="content">

    <header class="topbar">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <button id="themeToggle" class="outline-btn">üåô</button>
      <h1>Settings</h1>
      <div class="avatar">ADMIN</div>
    </header>

    <!-- ORGANIZATION PROFILE -->
    <section class="panel">
      <h3>Organization Profile</h3>

      <div class="form-grid">
        <div>
          <label>Organization Name</label>
          <input type="text" id="orgName">
        </div>

        <div>
          <label>Contact Number</label>
          <input type="text" id="contact">
        </div>
      </div>

      <button class="primary-btn" style="margin-top:16px;" onclick="saveSettings()">
        Save Changes
      </button>

      <p id="saveMsg" style="display:none;color:green;margin-top:8px;">
        Settings saved successfully
      </p>
    </section>

    <!-- PREFERENCES -->
    <section class="panel">
      <h3>Preferences</h3>

      <div class="toggle">
        <input type="checkbox" id="emailNotif">
        <span>Enable email notifications</span>
      </div>

      <div class="toggle">
        <input type="checkbox" id="expiryNotif">
        <span>Notify on expiring food</span>
      </div>

      <div class="toggle">
        <input type="checkbox" id="weeklyReport">
        <span>Enable weekly summary reports</span>
      </div>
    </section>

  </main>
</div>

<script>
/* ===== BASE URL (RENDER BACKEND) ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";

/* ===== AUTH HEADERS ===== */
function authHeaders() {
  return {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + token
  };
}

/* ===== LOAD SETTINGS ===== */
fetch(`${BASE_URL}/api/settings?email=${email}`, {
  headers: authHeaders()
})
.then(res => {
  if (res.status === 401) {
    localStorage.clear();
    window.location.href = "../index.html";
    return null;
  }
  return res.ok ? res.json() : null;
})
.then(data => {
  if (!data) return;

  orgName.value = data.organizationName || "";
  contact.value = data.contactNumber || "";
  emailNotif.checked   = !!data.emailNotifications;
  expiryNotif.checked  = !!data.expiryNotifications;
  weeklyReport.checked = !!data.weeklyReports;
})
.catch(err => console.error("Settings load error:", err));

/* ===== SAVE SETTINGS ===== */
function saveSettings() {
  fetch(`${BASE_URL}/api/settings?email=${email}`, {
    method: "PUT",
    headers: authHeaders(),
    body: JSON.stringify({
      organizationName: orgName.value,
      contactNumber: contact.value,
      emailNotifications: emailNotif.checked,
      expiryNotifications: expiryNotif.checked,
      weeklyReports: weeklyReport.checked
    })
  })
  .then(res => {
    if (res.status === 401) {
      localStorage.clear();
      window.location.href = "../index.html";
      return;
    }

    if (!res.ok) return;

    saveMsg.style.display = "block";
    setTimeout(() => saveMsg.style.display = "none", 2500);
  })
  .catch(err => console.error("Settings save error:", err));
}

/* LOGOUT */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};

function toggleSidebar() {
  document.querySelector(".sidebar").classList.toggle("open");
}
</script>

<script src="../js/app.js"></script>
</body>
</html>
