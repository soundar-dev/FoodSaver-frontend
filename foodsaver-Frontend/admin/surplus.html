<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Surplus Food</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body>

<script>
/* üîê ADMIN GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role?.toUpperCase() !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a class="active">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <main class="content">

    <header class="topbar">
      <h1>Surplus Food</h1>
      <div class="top-actions">
        <input type="search" id="searchInput" placeholder="Search food / location / NGO" />
        <button class="primary-btn" type="button" onclick="toggleForm()">+ Add Surplus</button>
        <div class="avatar">ADMIN</div>
      </div>
    </header>

    <!-- ADD SURPLUS FORM -->
    <section id="surplusForm" class="panel hidden">
      <h3>Add Surplus Food</h3>

      <div class="form-grid">
        <input type="text" id="foodName" placeholder="Food name" />
        <input type="text" id="location" placeholder="Location" />
        <input type="number" id="quantity" placeholder="Serves (quantity)" />
        <input type="number" id="expiryHours" placeholder="Expiry (hours)" />
      </div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <button type="button" class="primary-btn" onclick="submitSurplus()">Submit</button>
        <button type="button" class="outline-btn" onclick="toggleForm()">Cancel</button>
      </div>
    </section>

    <!-- SURPLUS CARDS -->
    <section class="surplus-grid" id="adminGrid"></section>

  </main>
</div>

<script>
/* ===== BACKEND ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";
const API_BASE = `${BASE_URL}/api/surplus`;

function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}

/* TOGGLE FORM */
function toggleForm() {
  document.getElementById("surplusForm").classList.toggle("hidden");
}

/* ADD SURPLUS */
function submitSurplus() {
  fetch(`${API_BASE}/add`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({
      foodName: foodName.value.trim(),
      location: location.value.trim(),
      quantity: Number(quantity.value),
      expiryHours: Number(expiryHours.value)
    })
  }).then(() => {
    foodName.value = "";
    location.value = "";
    quantity.value = "";
    expiryHours.value = "";
    toggleForm();
    loadSurplus();
  });
}

/* LOAD SURPLUS */
let adminData = [];

function loadSurplus() {
  fetch(`${API_BASE}/admin/cards`, { headers: authHeaders() })
    .then(res => res.json())
    .then(data => {
      adminData = data;
      renderAdmin(adminData);
      enableSearch(adminData);
    });
}

/* SEARCH */
function enableSearch(sourceData) {
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase().trim();
    if (!q) return renderAdmin(sourceData);

    renderAdmin(
      sourceData.filter(item =>
        item.foodName?.toLowerCase().includes(q) ||
        item.location?.toLowerCase().includes(q) ||
        item.status?.toLowerCase().includes(q) ||
        item.postedBy?.toLowerCase().includes(q) ||
        item.acceptedByOrg?.toLowerCase().includes(q)
      )
    );
  });
}

/* DELETE */
function deleteSurplus(id) {
  fetch(`${API_BASE}/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  }).then(loadSurplus);
}

/* RENDER */
function renderAdmin(data) {
  adminGrid.innerHTML = "";

  if (!data.length) {
    adminGrid.innerHTML = "<p>No surplus found.</p>";
    return;
  }

  data.forEach(item => {
    let statusClass = "available";
    if (item.status === "ACCEPTED") statusClass = "pending";
    if (item.status === "PICKED") statusClass = "success";

    adminGrid.innerHTML += `
      <div class="surplus-card">
        <button class="delete-btn" onclick="deleteSurplus(${item.id})">‚úï</button>

        <h3>${item.foodName}</h3>
        <p>üìç ${item.location}</p>
        <p>üë• Serves: ${item.quantity}</p>

        ${item.acceptedByOrg
          ? `<p>ü§ù Accepted by: <b>${item.acceptedByOrg}</b></p>`
          : ""
        }

        <span class="tag ${statusClass}">${item.status}</span>
      </div>
    `;
  });
}

/* INIT */
loadSurplus();

/* LOGOUT */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

<script src="../js/app.js"></script>
</body>
</html>
