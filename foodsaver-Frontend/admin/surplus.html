<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Food Saver | Surplus Food</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body>

<script>
/* üîê ADMIN GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role?.toUpperCase() !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <aside class="sidebar">
  <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>  
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a class="active">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <main class="content">

    <header class="topbar surplus-topbar">
       <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
        <button id="themeToggle" class="outline-btn">üåô</button>
      <h1>Surplus Food</h1>
      <div class="top-actions">
        <input type="search" id="searchInput" placeholder="Search food / location / NGO" />
        <button class="primary-btn" type="button" onclick="toggleForm()">+ Add Surplus</button>
        <div class="avatar">ADMIN</div>
      </div>
    </header>

    <div class="mobile-add-btn">
          <button class="primary-btn" type="button" onclick="toggleForm()">+ Add Surplus</button>
      </div>

    <!-- ‚úÖ ADD SURPLUS FORM -->
    <section id="surplusForm" class="panel hidden">
      <h3>Add Surplus Food</h3>

      <div class="form-grid">
        <input type="text" id="foodName" placeholder="Food name" />
        <input type="text" id="location" placeholder="Location" />
        <input type="number" id="quantity" placeholder="Serves (quantity)" />
        <input type="number" id="expiryHours" placeholder="Expiry (hours)" />
      </div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <button type="button" class="primary-btn" onclick="submitSurplus()">Submit</button>
        <button type="button" class="outline-btn" onclick="toggleForm()">Cancel</button>
      </div>
    </section>

    <!-- ‚úÖ SURPLUS CARDS -->
    <section class="surplus-grid" id="adminGrid"></section>

  </main>
</div>

<script>
/* ===== BACKEND (RENDER) ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";
const API_BASE = `${BASE_URL}/api/surplus`;

function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}

/* ===== TOGGLE FORM ===== */
function toggleForm() {
  document.getElementById("surplusForm").classList.toggle("hidden");
}  

/* ===== ADD SURPLUS ===== */
function submitSurplus() {
  const foodNameEl = document.getElementById("foodName");
  const locationEl = document.getElementById("location");
  const quantityEl = document.getElementById("quantity");
  const expiryEl   = document.getElementById("expiryHours");

  fetch(`${API_BASE}/add`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({
      foodName: foodNameEl.value.trim(),
      location: locationEl.value.trim(),
      quantity: Number(quantityEl.value),
      expiryHours: Number(expiryEl.value)
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Add failed");

    // ‚úÖ CLEAR INPUTS
    foodNameEl.value = "";
    locationEl.value = "";
    quantityEl.value = "";
    expiryEl.value = "";

    // ‚úÖ HIDE FORM
    document.getElementById("surplusForm").classList.add("hidden");

    // ‚úÖ REFRESH CARDS
    loadSurplus();
  })
  .catch(err => console.error("Add surplus error:", err));
}
/* ===== LOAD SURPLUS ===== */
let adminData = [];

function loadSurplus() {
  fetch(`${API_BASE}/admin/cards`, { headers: authHeaders() })
    .then(res => res.json())
    .then(data => {
      adminData = data;
      renderAdmin(adminData);
      enableSearch(adminData); // ‚úÖ attach search once
    })
    .catch(err => console.error("Load error:", err));
}
function enableSearch(sourceData) {
  const searchInput = document.getElementById("searchInput");

  if (!searchInput) return;

  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase().trim();

    if (!q) {
      renderAdmin(sourceData);
      return;
    }

    const filtered = sourceData.filter(item =>
  item.foodName?.toLowerCase().includes(q) ||
  item.location?.toLowerCase().includes(q) ||
  item.status?.toLowerCase().includes(q) ||
  item.postedBy?.toLowerCase().includes(q) ||      // üè¢ who posted
  item.acceptedByOrg?.toLowerCase().includes(q)       // ü§ù who accepted
);

    renderAdmin(filtered);
  });
}  
function getExpiryText(createdAt, expiryHours) {
  if (!expiryHours) return "";

  // üîí HARD GUARD ‚Äî prevents crash
  if (!createdAt || typeof createdAt !== "string") {
    return `‚è± Expires in ${expiryHours} hrs`;
  }

  let created;

  // Handle ISO vs MySQL datetime safely
  if (createdAt.includes("T")) {
    created = new Date(createdAt);
  } else {
    created = new Date(createdAt.replace(" ", "T") + "Z");
  }

  // üîí If still invalid, fallback safely
  if (isNaN(created.getTime())) {
    return `‚è± Expires in ${expiryHours} hrs`;
  }

  const expiry = new Date(created.getTime() + expiryHours * 3600000);
  const now = new Date();

  const diffMs = expiry - now;
  if (diffMs <= 0) return "‚ùå Expired";

  const h = Math.floor(diffMs / 3600000);
  const m = Math.floor((diffMs % 3600000) / 60000);
  const s = Math.floor((diffMs % 60000) / 1000);

  return `‚è± Expires in ${h}h ${m}m ${s}s`;
}
/* ===== DELETE ===== */
function deleteSurplus(id) {
  fetch(`${API_BASE}/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  })
  .then(res => {
    if (!res.ok) {
      throw new Error("Delete failed");
    }
    loadSurplus(); // refresh cards
  })
  .catch(err => console.error("Delete error:", err));
}

function markPicked(id) {
  fetch(`${API_BASE}/${id}/picked`, {
    method: "PUT",
    headers: authHeaders()
  })
  .then(res => {
    if (!res.ok) throw new Error("Update failed");
    loadSurplus(); // refresh admin cards
  })
  .catch(err => console.error("Pick error:", err));
}

/* ===== RENDER ===== */
function renderAdmin(data) {
  const grid = document.getElementById("adminGrid");
  grid.innerHTML = "";

  if (!data.length) {
    grid.innerHTML = "<p>No surplus found.</p>";
    return;
  }

  data.forEach(item => {
    let statusClass = "available";
    if (item.status === "ACCEPTED") statusClass = "pending";
    if (item.status === "PICKED") statusClass = "success";

  grid.innerHTML += `
  <div class="surplus-card">
    <button class="delete-btn" onclick="deleteSurplus(${item.id})">‚úï</button>

    <h3>${item.foodName}</h3>
    <p>üìç ${item.location}</p>
    <p>üë• Serves: ${item.quantity}</p>
   

    ${item.acceptedByOrg
      ? `<p>ü§ù Accepted by: <b>${item.acceptedByOrg}</b></p>`
      : ""
    }

    <p>${getExpiryText(item.createdAt, item.expiryHours)}</p>

    ${item.status === "ACCEPTED"
  ? `<button class="primary-btn small"
       onclick="markPicked(${item.id})">
       Mark as Picked
     </button>`
  : ""
}

    <span class="tag ${statusClass}">${item.status}</span>
  </div>
`;
  });
}

loadSurplus();

/* ===== LOGOUT ===== */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

  <script>
function toggleSidebar() {
  document.querySelector(".sidebar").classList.toggle("open");
}
</script>

<script src="../js/app.js"></script>
</body>
</html>















