<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Surplus Food</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a class="active">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <main class="content">

    <header class="topbar">
      <h1>Surplus Food</h1>
      <div class="top-actions">
        <input type="search" id="searchInput" placeholder="Search food / location / NGO" />
        <button class="primary-btn" onclick="toggleForm()">+ Add Surplus</button>
        <div class="avatar">ADMIN</div>
      </div>
    </header>

    <section class="surplus-grid" id="adminGrid"></section>
  </main>
</div>

<script>
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../login.html";
}

const API_BASE = "http://localhost:8080/api/surplus";

function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}

let adminData = [];

/* ================= RENDER ================= */
function renderAdmin(data) {
  const grid = document.getElementById("adminGrid");
  grid.innerHTML = "";

  if (!data.length) {
    grid.innerHTML = "<p>No surplus found.</p>";
    return;
  }

  data.forEach(item => {
    let statusClass = "success";
    if (item.status === "ACCEPTED") statusClass = "pending";
    if (item.status === "PICKED") statusClass = "neutral";

    grid.innerHTML += `
      <div class="surplus-card">
        <h3>${item.foodName}</h3>
        <p>üìç ${item.location}</p>
        <p>üë• Serves: ${item.quantity}</p>
        <p>üè¢ Posted by: <b>${item.postedBy}</b></p>
        ${
          item.acceptedByOrg
          ? `<p>ü§ù Accepted by: <b>${item.acceptedByOrg}</b></p>`
          : ""
        }
        <span class="tag ${statusClass}">${item.status}</span>
      </div>
    `;
  });
}

/* ================= LOAD ================= */
function loadSurplus() {
  fetch(`${API_BASE}/admin/cards`, { headers: authHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(data => {
      adminData = data;
      renderAdmin(adminData);
      enableSearch(adminData, renderAdmin);
    });
}

/* ================= SEARCH (UNIVERSAL) ================= */
function enableSearch(source, renderFn) {
  const searchBox = document.getElementById("searchInput");

  searchBox.addEventListener("input", e => {
    const q = e.target.value.toLowerCase().trim();

    if (!q) {
      renderFn(source);
      return;
    }

    renderFn(
      source.filter(i =>
        (i.foodName && i.foodName.toLowerCase().includes(q)) ||
        (i.location && i.location.toLowerCase().includes(q)) ||
        (i.postedBy && i.postedBy.toLowerCase().includes(q)) ||
        (i.acceptedByOrg && i.acceptedByOrg.toLowerCase().includes(q))
      )
    );
  });
}

loadSurplus();

logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../login.html";
};
</script>

<script src="../js/app.js"></script>
</body>
</html>
