<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Surplus Food</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body>

<script>
/* üîê ADMIN AUTH GUARD */
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role?.toUpperCase() !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a class="active">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <!-- HEADER -->
    <header class="topbar">
      <h1>Surplus Food</h1>
      <div class="top-actions">
        <input type="search" id="searchInput" placeholder="Search food / location / NGO" />
        <button class="primary-btn" onclick="toggleForm()">+ Add Surplus</button>
        <div class="avatar">ADMIN</div>
      </div>
    </header>

    <!-- ADD SURPLUS FORM -->
    <section id="surplusForm" class="panel hidden">
      <h3>Add Surplus Food</h3>

      <div class="form-grid">
        <input type="text" id="foodName" placeholder="Food name" />
        <input type="text" id="location" placeholder="Location" />
        <input type="number" id="quantity" placeholder="Serves (quantity)" />
        <input type="number" id="expiryHours" placeholder="Expiry (hours)" />
      </div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <button class="primary-btn" onclick="submitSurplus()">Submit</button>
        <button class="outline-btn" onclick="toggleForm()">Cancel</button>
      </div>
    </section>

    <!-- CARDS -->
    <section class="surplus-grid" id="adminGrid"></section>

  </main>
</div>

<script>
/* ===== BACKEND ===== */
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";
const API_BASE = `${BASE_URL}/api/surplus`;

function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}

let adminData = [];

/* ===== TOGGLE FORM ===== */
function toggleForm() {
  document.getElementById("surplusForm").classList.toggle("hidden");
}

/* ===== SUBMIT ===== */
function submitSurplus() {
  const foodName = foodNameInput.value.trim();
  const location = locationInput.value.trim();
  const quantity = quantityInput.value;
  const expiry   = expiryHoursInput.value;

  if (!foodName || !location || !quantity || !expiry) {
    alert("Fill all fields");
    return;
  }

  fetch(`${API_BASE}/add`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({ foodName, location, quantity, expiryHours: expiry })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(() => {
    toggleForm();
    loadSurplus();
  })
  .catch(() => alert("Failed to add surplus"));
}

/* ===== DELETE SURPLUS ===== */
function deleteSurplus(id) {
  if (!confirm("Delete this surplus?")) return;

  fetch(`${API_BASE}/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  })
  .then(res => {
    if (!res.ok) throw new Error();
    loadSurplus();
  })
  .catch(() => alert("Delete failed"));
}

/* ===== LOAD ===== */
function loadSurplus() {
  fetch(`${API_BASE}/admin/cards`, { headers: authHeaders() })
    .then(res => res.ok ? res.json() : [])
    .then(data => {
      adminData = data;
      renderAdmin(adminData);
      enableSearch(adminData);
    });
}

/* ===== RENDER ===== */
function renderAdmin(data) {
  adminGrid.innerHTML = "";

  if (!data.length) {
    adminGrid.innerHTML = "<p>No surplus found.</p>";
    return;
  }

  data.forEach(item => {
    adminGrid.innerHTML += `
      <div class="surplus-card">
        <button class="delete-btn" onclick="deleteSurplus(${item.id})">‚úñ</button>

        <h3>${item.foodName}</h3>
        <p>üìç ${item.location}</p>
        <p>üë• Serves: ${item.quantity}</p>
        <p>‚è± Expires in: <b>${item.expiryHours} hrs</b></p>
        <p>üè¢ Posted by: <b>${item.postedBy}</b></p>

        <span class="tag success">${item.status}</span>
      </div>
    `;
  });
}

/* ===== SEARCH ===== */
function enableSearch(source) {
  searchInput.oninput = e => {
    const q = e.target.value.toLowerCase().trim();
    if (!q) return renderAdmin(source);

    renderAdmin(
      source.filter(i =>
        i.foodName?.toLowerCase().includes(q) ||
        i.location?.toLowerCase().includes(q)
      )
    );
  };
}

/* INIT */
const foodNameInput    = document.getElementById("foodName");
const locationInput    = document.getElementById("location");
const quantityInput    = document.getElementById("quantity");
const expiryHoursInput = document.getElementById("expiryHours");

loadSurplus();

/* LOGOUT */
logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

<script src="../js/app.js"></script>
</body>
</html>
