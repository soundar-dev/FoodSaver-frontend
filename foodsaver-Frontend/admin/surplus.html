<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Saver | Surplus Food</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body>

<script>
const token = localStorage.getItem("token");
const role  = localStorage.getItem("role");

if (!token || role?.toUpperCase() !== "ADMIN") {
  localStorage.clear();
  window.location.href = "../index.html";
}
</script>

<div class="app">

  <aside class="sidebar">
    <h2 class="logo">FoodSaver</h2>
    <nav>
      <a data-page="dashboard.html">Dashboard</a>
      <a class="active">Surplus Food</a>
      <a data-page="redistribution.html">Food Pickup & Delivery</a>
      <a data-page="settings.html">Settings</a>
      <a id="logoutBtn">Logout</a>
    </nav>
  </aside>

  <main class="content">

    <header class="topbar">
      <h1>Surplus Food</h1>
      <div class="top-actions">
        <input type="search" id="searchInput" placeholder="Search food / location / NGO" />
        <button class="primary-btn" onclick="toggleForm()">+ Add Surplus</button>
        <div class="avatar">ADMIN</div>
      </div>
    </header>

    <!-- ADD FORM -->
    <section id="surplusForm" class="panel hidden">
      <h3>Add Surplus Food</h3>

      <div class="form-grid">
        <input id="foodName" placeholder="Food name" />
        <input id="location" placeholder="Location" />
        <input type="number" id="quantity" placeholder="Serves (quantity)" />
        <input type="number" id="expiryHours" placeholder="Expiry (hours)" />
      </div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <button class="primary-btn" onclick="submitSurplus()">Submit</button>
        <button class="outline-btn" onclick="toggleForm()">Cancel</button>
      </div>
    </section>

    <!-- CARDS -->
    <section class="surplus-grid" id="adminGrid"></section>

  </main>
</div>

<script>
const BASE_URL = "https://foodsaver-backend-d964.onrender.com";
const API_BASE = `${BASE_URL}/api/surplus`;

function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}

function toggleForm() {
  document.getElementById("surplusForm").classList.toggle("hidden");
}

function submitSurplus() {
  fetch(`${API_BASE}/add`, {
    method: "POST",
    headers: authHeaders(),
    body: JSON.stringify({
      foodName: foodName.value,
      location: location.value,
      quantity: quantity.value,
      expiryHours: expiryHours.value
    })
  }).then(() => {
    toggleForm();
    loadSurplus();
  });
}

function loadSurplus() {
  fetch(`${API_BASE}/admin/cards`, { headers: authHeaders() })
    .then(r => r.json())
    .then(renderAdmin);
}

function deleteSurplus(id) {
  fetch(`${API_BASE}/admin/delete/${id}`, {
    method: "DELETE",
    headers: authHeaders()
  }).then(loadSurplus);
}

function renderAdmin(data) {
  adminGrid.innerHTML = "";
  data.forEach(item => {
    adminGrid.innerHTML += `
      <div class="surplus-card">
        <button class="delete-btn" onclick="deleteSurplus(${item.id})">‚úï</button>
        <h3>${item.foodName}</h3>
        <p>üìç ${item.location}</p>
        <p>üë• Serves: ${item.quantity}</p>
        <p>‚è± Expires in: <b>${item.expiryHours} hrs</b></p>
        <span class="tag success">${item.status}</span>
      </div>
    `;
  });
}

loadSurplus();

logoutBtn.onclick = () => {
  localStorage.clear();
  window.location.href = "../index.html";
};
</script>

<script src="../js/app.js"></script>
</body>
</html>
